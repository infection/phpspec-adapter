# yamllint disable rule:line-length
# yamllint disable rule:braces

name: Update Tool Versions

on:
  schedule:
    # Run daily at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write       # Required to create a new branch and commit the changes
  pull-requests: write  # Required to create the PR
  actions: write        # Required to trigger workflow dispatch events

jobs:
  update-tool-version:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool:
          - name: Infection
            repo: infection/infection
            version-file: .tools/infection-version
          - name: PHPSpec
            repo: phpspec/phpspec
            version-file: .tools/phpspec-version

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Get latest ${{ matrix.tool.name }} release
        id: latest-release
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/${{ matrix.tool.repo }}/releases/latest | jq -r '.tag_name')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest ${{ matrix.tool.name }} version: $LATEST_VERSION"

      - name: Get current version
        id: current-version
        run: |
          CURRENT_VERSION=$(cat ${{ matrix.tool.version-file }})
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Compare versions
        id: compare
        run: |
          LATEST="${{ steps.latest-release.outputs.version }}"
          CURRENT="${{ steps.current-version.outputs.version }}"

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Version mismatch detected: $CURRENT -> $LATEST"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Version is up to date: $CURRENT"
          fi

      - name: Update ${{ matrix.tool.version-file }} file
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          echo "${{ steps.latest-release.outputs.version }}" > ${{ matrix.tool.version-file }}
          echo "Updated ${{ matrix.tool.version-file }} to ${{ steps.latest-release.outputs.version }}"

      - name: Create Pull Request
        if: steps.compare.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/update-${{ matrix.tool.name }}
          delete-branch: true
          commit-message: |
            chore: Update ${{ matrix.tool.name }} to ${{ steps.latest-release.outputs.version }}

            Automated update of ${{ matrix.tool.name }} version from ${{ steps.current-version.outputs.version }} to ${{ steps.latest-release.outputs.version }}.
          title: "chore: Update ${{ matrix.tool.name }} to ${{ steps.latest-release.outputs.version }}"
          body: |
            This PR updates the ${{ matrix.tool.name }} version from **${{ steps.current-version.outputs.version }}** to **${{ steps.latest-release.outputs.version }}**.

            ---

            This PR was automatically created by the [Update Tool Versions workflow](.github/workflows/update.yaml).

      - name: Display GitHub CLI version
        if: steps.compare.outputs.needs_update == 'true'
        run: gh --version

      - name: Trigger CI workflows
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          BRANCH="chore/update-${{ matrix.tool.name }}"

          echo "Triggering CI workflows for branch: $BRANCH"

          gh workflow run cs.yaml --ref "$BRANCH"
          gh workflow run tests.yaml --ref "$BRANCH"
          gh workflow run mutation-testing.yaml --ref "$BRANCH"

          echo "CI workflows triggered successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
